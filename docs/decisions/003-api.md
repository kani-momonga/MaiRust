# 003: API 設計 (API Design)

**ステータス**: Draft
**最終更新**: 2024-XX-XX
**担当領域**: Backend / Frontend

---

## 概要

MaiRust の REST API 設計を定義します。エンドポイント構造、バージョニング、ページネーション、レート制限などを記載します。

---

## 1. 基本方針

### 1.1 REST vs GraphQL

| API | 位置づけ |
|-----|----------|
| REST | **プライマリ API** |
| GraphQL | 将来オプション（高度なクライアント向け） |

**理由:**
- 管理系・Webhook・プラグイン連携は REST が扱いやすい
- 初期フェーズでは開発・運用コストを REST に集中

### 1.2 設計原則

- リソース指向（名詞ベースの URL）
- HTTP メソッドの適切な使用（GET/POST/PUT/PATCH/DELETE）
- 一貫したエラーレスポンス形式
- OpenAPI (Swagger) によるドキュメント自動生成

---

## 2. バージョニング

### 2.1 方式

**URL プレフィックス方式** を採用：

```
/api/v1/users
/api/v1/messages
```

### 2.2 バージョンアップポリシー

- メジャーバージョンアップ時に `/api/v2/` を追加
- 旧バージョンは **12〜24ヶ月** サポート
- 廃止予定のエンドポイントには `Deprecation` ヘッダを付与

**Deprecation ヘッダ例:**
```http
Deprecation: true
Sunset: Sat, 31 Dec 2025 23:59:59 GMT
Link: </api/v2/users>; rel="successor-version"
```

---

## 3. エンドポイント構造

### 3.1 概要

| パス | 用途 |
|------|------|
| `/api/v1/auth/*` | 認証関連 |
| `/api/v1/users/*` | ユーザー管理 |
| `/api/v1/domains/*` | ドメイン管理 |
| `/api/v1/mailboxes/*` | メールボックス |
| `/api/v1/messages/*` | メッセージ操作 |
| `/api/v1/admin/hooks/*` | Hook 管理 |
| `/api/v1/admin/plugins/*` | プラグイン管理 |
| `/api/v1/admin/settings/*` | システム設定 |
| `/internal/plugins/*` | プラグイン用内部 API |

### 3.2 認証 API

```
POST   /api/v1/auth/login          # ログイン
POST   /api/v1/auth/logout         # ログアウト
POST   /api/v1/auth/refresh        # トークンリフレッシュ
GET    /api/v1/auth/me             # 現在のユーザー情報
```

### 3.3 ユーザー API

```
GET    /api/v1/users               # ユーザー一覧
POST   /api/v1/users               # ユーザー作成
GET    /api/v1/users/:id           # ユーザー詳細
PUT    /api/v1/users/:id           # ユーザー更新
DELETE /api/v1/users/:id           # ユーザー削除
```

### 3.4 メッセージ API

```
GET    /api/v1/messages            # メッセージ一覧（検索・フィルタ）
GET    /api/v1/messages/:id        # メッセージ詳細
GET    /api/v1/messages/:id/raw    # 生メッセージ（EML）
PATCH  /api/v1/messages/:id        # フラグ・タグ更新
DELETE /api/v1/messages/:id        # メッセージ削除
POST   /api/v1/messages/:id/move   # フォルダ移動
```

### 3.5 送信 API

```
POST   /api/v1/send                # メール送信
```

### 3.6 Hook 管理 API

```
GET    /api/v1/admin/hooks         # Hook 一覧
POST   /api/v1/admin/hooks         # Hook 作成
GET    /api/v1/admin/hooks/:id     # Hook 詳細
PUT    /api/v1/admin/hooks/:id     # Hook 更新
DELETE /api/v1/admin/hooks/:id     # Hook 削除
POST   /api/v1/admin/hooks/:id/test # Hook テスト実行
```

### 3.7 プラグイン管理 API

```
GET    /api/v1/admin/plugins           # プラグイン一覧
POST   /api/v1/admin/plugins           # プラグインインストール
GET    /api/v1/admin/plugins/:id       # プラグイン詳細
DELETE /api/v1/admin/plugins/:id       # プラグインアンインストール
POST   /api/v1/admin/plugins/:id/enable   # 有効化
POST   /api/v1/admin/plugins/:id/disable  # 無効化
GET    /api/v1/admin/plugins/:id/logs     # プラグインログ
```

### 3.8 プラグイン用内部 API

```
POST   /internal/plugins/callback/:message_id  # 処理結果コールバック
GET    /internal/plugins/messages/:id          # メッセージ取得（権限に応じて）
```

---

## 4. リクエスト・レスポンス形式

### 4.1 Content-Type

- リクエスト: `application/json`
- レスポンス: `application/json`

### 4.2 成功レスポンス

**単一リソース:**
```json
{
  "data": {
    "id": "user_abc123",
    "email": "user@example.com",
    "name": "John Doe",
    "created_at": "2024-01-15T10:30:00Z"
  }
}
```

**リスト:**
```json
{
  "data": [
    { "id": "msg_001", "subject": "Hello" },
    { "id": "msg_002", "subject": "World" }
  ],
  "pagination": {
    "cursor": "eyJpZCI6Im1zZ18wMDIifQ==",
    "has_more": true
  }
}
```

### 4.3 エラーレスポンス

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "The request body is invalid",
    "details": [
      {
        "field": "email",
        "reason": "Invalid email format"
      }
    ]
  }
}
```

**エラーコード一覧:**

| コード | HTTP Status | 説明 |
|--------|-------------|------|
| `INVALID_REQUEST` | 400 | リクエスト形式不正 |
| `UNAUTHORIZED` | 401 | 認証エラー |
| `FORBIDDEN` | 403 | 権限不足 |
| `NOT_FOUND` | 404 | リソース不存在 |
| `CONFLICT` | 409 | 競合（重複等） |
| `VALIDATION_ERROR` | 422 | バリデーションエラー |
| `RATE_LIMITED` | 429 | レート制限超過 |
| `INTERNAL_ERROR` | 500 | サーバー内部エラー |

---

## 5. ページネーション

### 5.1 方式

**カーソルベース** を推奨（デフォルト）。

**リクエスト:**
```
GET /api/v1/messages?limit=50&cursor=eyJpZCI6Im1zZ18wMDIifQ==
```

**レスポンス:**
```json
{
  "data": [...],
  "pagination": {
    "cursor": "eyJpZCI6Im1zZ18wNTAifQ==",
    "has_more": true
  }
}
```

### 5.2 オフセットベース（一部 API）

ログなど順序が重要でない場合に使用：

```
GET /api/v1/admin/logs?limit=100&offset=200
```

### 5.3 パラメータ

| パラメータ | デフォルト | 最大 |
|-----------|-----------|------|
| `limit` | 50 | 100 |
| `cursor` | なし | - |
| `offset` | 0 | 10000 |

---

## 6. フィルタ・ソート

### 6.1 フィルタ

クエリパラメータで指定：

```
GET /api/v1/messages?from=sender@example.com&after=2024-01-01
```

**共通フィルタ:**

| パラメータ | 説明 |
|-----------|------|
| `q` | 全文検索クエリ |
| `after` | 指定日時以降 |
| `before` | 指定日時以前 |
| `from` | 送信者アドレス |
| `to` | 受信者アドレス |
| `tag` | タグ |
| `folder` | フォルダ |

### 6.2 ソート

```
GET /api/v1/messages?sort=-date  # 日付降順
GET /api/v1/messages?sort=date   # 日付昇順
```

---

## 7. レート制限

### 7.1 制限値

| 対象 | 制限 |
|------|------|
| 一般ユーザー | 60 req/min |
| Admin API | 30 req/min per IP |
| プラグイン用内部 API | トークンごとに設定 |

### 7.2 レスポンスヘッダ

```http
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 45
X-RateLimit-Reset: 1705312800
```

### 7.3 制限超過時

```http
HTTP/1.1 429 Too Many Requests
Retry-After: 30

{
  "error": {
    "code": "RATE_LIMITED",
    "message": "Rate limit exceeded. Try again in 30 seconds."
  }
}
```

---

## 8. 認証

詳細は [004-authentication.md](./004-authentication.md) を参照。

### 8.1 API Key

```http
Authorization: Bearer <api_key>
```

### 8.2 セッション Cookie

Admin UI からのリクエストはセッション Cookie で認証。

---

## 9. CORS

### 9.1 設定

```yaml
api:
  cors:
    allowed_origins:
      - "https://admin.example.com"
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "PATCH"
      - "DELETE"
    allowed_headers:
      - "Authorization"
      - "Content-Type"
    max_age: 86400
```

---

## 10. OpenAPI ドキュメント

### 10.1 エンドポイント

```
GET /api/v1/openapi.json   # OpenAPI 仕様
GET /api/v1/docs           # Swagger UI
```

### 10.2 自動生成

Rust コードから OpenAPI 仕様を自動生成：
- `utoipa` クレート等を使用
- CI でドキュメントを自動デプロイ

---

## 11. Webhook（外部通知）

### 11.1 概要

特定のイベント発生時に外部 URL へ HTTP POST を送信。

### 11.2 イベント種類

| イベント | 説明 |
|---------|------|
| `message.received` | メール受信時 |
| `message.sent` | メール送信時 |
| `user.created` | ユーザー作成時 |
| `plugin.error` | プラグインエラー時 |

### 11.3 Webhook ペイロード

```json
{
  "event": "message.received",
  "timestamp": "2024-01-15T10:30:00Z",
  "data": {
    "message_id": "msg_abc123",
    "from": "sender@example.com",
    "to": ["recipient@example.com"],
    "subject": "Hello"
  }
}
```

### 11.4 署名検証

```http
X-MaiRust-Signature: sha256=<signature>
X-MaiRust-Timestamp: 1705312800
```

---

## 関連ドキュメント

- [004-authentication.md](./004-authentication.md) - 認証・セキュリティ
- [005-hooks.md](./005-hooks.md) - Hook Manager
- [006-plugins.md](./006-plugins.md) - プラグインアーキテクチャ
