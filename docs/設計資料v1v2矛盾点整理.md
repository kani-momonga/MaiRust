設計ノート v2 へのフィードバック - 最終確認事項
1. 設計の矛盾・要調整箇所
1.1 Hook タイムアウトと Circuit Breaker の整合性
現状の設計:

pre_receive タイムアウト: 最大5秒
Circuit Breaker: 連続10回失敗 or 5分間の失敗率 > 80%
懸念:

タイムアウト(5秒) × 10回 = 50秒 の間、SMTPセッションが連続で遅延する可能性
高トラフィック時に「5分間の失敗率80%」の判定が遅すぎないか？
提案:

pre_receive 専用の厳しいCircuit Breaker設定を検討
例: 連続3回タイムアウト → 即座にCircuit Open
1.2 read-only IMAP と権限システムの整合性
現状の設計:

read-only IMAP: フラグ変更・移動・削除不可
プラグイン権限: write_flags, move_message が定義済み
疑問:

プラグインが write_flags で既読フラグを付けた場合、IMAPクライアントからはどう見えるか？
IMAPでは読めるがフラグ変更できない → ユーザー混乱の可能性
提案:

Phase 2.5 で IMAP 書き込み対応するまで、write_flags 等の権限は「Web UI/API経由のみ有効」と明記
1.3 送信スパム対策と pre_send Hook の順序
現状の設計:

pre_send Hook でプラグインを呼び出し
Outbound Policy Engine でスコアリング
疑問:

プラグインとPolicy Engineの実行順序は？
A) プラグイン → Policy Engine（プラグイン結果をスコアに反映）
B) Policy Engine → プラグイン（先にレート制限でブロック）
C) 並列実行
提案:

B) を推奨: 明らかなレート超過は先にブロックし、プラグイン呼び出しコストを削減
2. 実装詳細の不足箇所
2.1 認証・セッション管理
項目	状況	不足点
Admin UI 認証	未定義	セッション方式（JWT/Cookie）、MFA対応
API 認証	未定義	APIキー vs OAuth2、トークン有効期限
SMTP AUTH	未定義	PLAIN/LOGIN/CRAM-MD5 等のサポート範囲
2.2 マルチテナント設計
現状: ドキュメント内で「テナント」という言葉が出てくるが、詳細未定義

疑問:

テナント = ドメイン？ それとも別概念（組織単位）？
テナント間のデータ分離レベル（論理分離 vs 物理分離）
テナントごとのプラグイン設定の独立性
2.3 キュー実装
現状: architecture.md で NATS/Redis/RabbitMQ に言及

疑問:

Phase 1 のデフォルトキューは何か？
組み込みキュー（PostgreSQL LISTEN/NOTIFY or インメモリ）の検討は？
3. 運用シナリオの未検討事項
3.1 障害復旧シナリオ
シナリオ	検討状況
DBクラッシュ後のリカバリ	バックアップ方針のみ、手順未詳細
S3アクセス不可時の挙動	未定義（メール受信を一時停止？）
プラグインサーバー全停止時	Circuit Breakerで対応、だがフォールバック動作は？
3.2 アップグレードシナリオ
シナリオ	検討状況
MaiRust Core のローリングアップデート	未定義
DBスキーマ変更時のマイグレーション	未定義
破壊的API変更時の移行期間	12-24ヶ月とあるが、deprecation警告の仕組みは？
4. セキュリティ詳細
4.1 未定義のセキュリティ項目
項目	状況
TLS設定	SMTP STARTTLS / API の TLS バージョン・暗号スイートの推奨は？
秘密情報の保存	DB内の暗号化方式（envelope encryption の具体的実装）
監査ログ	誰がいつ何をしたかの記録フォーマット・保存期間
脆弱性対応	セキュリティアドバイザリの公開方針、CVE採番
4.2 プラグインセキュリティの追加検討
疑問:

プラグインが外部に情報を送信することを検知・防止する仕組みは？
network = "outbound-limited" でも、allowlistに入っている宛先への情報漏洩は防げない
プラグインの実行時間・リソース使用量の監視ダッシュボードは？
5. 具体的な数値・閾値の確認
項目	現在の値	確認事項
S3 multipart threshold	8MB	根拠は？AWS推奨との整合性
body preview	4KB	日本語メールでは約1300文字程度。十分か？
Hook timeout max	5秒	AI プラグインには短すぎないか？
Rate limit (user)	60 req/min	妥当性の検証方法は？
Circuit Breaker threshold	80%	閾値の根拠は？
削除メッセージ保持	30日	法的要件（e-Discovery等）との整合性
6. ドキュメント間の用語統一
用語	出現箇所	問題点
Hook vs Webhook	複数箇所	内部フックと外部Webhookの区別が曖昧
Plugin vs Worker	architecture.md	同じ？違う？
tenant vs domain vs organization	複数箇所	定義の明確化が必要
callback vs webhook	plugin-architecture.md	使い分けの基準
7. 次フェーズへの申し送り事項
以下は Phase 1 では不要だが、早期に方針を固めておくべき項目：

項目	理由
JMAP 対応方針	IMAP/POP より先にJMAPを検討する価値があるか
CalDAV/CardDAV	groupware 非対応とあるが、将来の方向性
E2E暗号化	PGP/S-MIME のサポート方針
Compliance	SOC2, ISO27001 等の認証取得計画
8. 最終確認チェックリスト
Phase 1 MVP 開始前に決定すべき事項
 Admin UI 認証方式（JWT vs Session Cookie）
 API 認証方式（API Key vs OAuth2）
 Phase 1 のキュー実装（組み込み vs 外部）
 SMTP AUTH のサポート範囲
 TLS 最小バージョン（1.2? 1.3?）
 ログフォーマットの最終仕様（JSON schema）
 エラーコード体系（REST API / SMTP）
 設定ファイルの完全なスキーマ定義
ドキュメント整備
 用語集（Glossary）の作成
 アーキテクチャ図（C4 model等）
 データモデル図（ER図）
 API エンドポイント一覧（Draft）