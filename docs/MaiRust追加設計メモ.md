# MaiRust 追加設計メモ  
コンテナ配布 / ストレージプラグイン / 送信スパム対策

本メモは、以下の追加要件を前提にした設計案です。

- Apache-2.0 ライセンス
- デフォルトDBは PostgreSQL（ただしユーザー選択可能）
- 将来的に Docker などのコンテナイメージで配布
- S3 など外部ストレージは「プラグイン的な構造」で切替可能（ただし公式ドライバとして同梱）
- スパム対策を「受信時」だけでなく「送信時」にも強化し、アカウント乗っ取りなどに強い設計

---

## 1. 配布モデル / コンテナ戦略

### 1.1 デフォルト配布方針（コンテナ）

**目標:**  
「`docker run mairust` で、外部依存なしの最小構成がすぐ動く」状態を提供する。

**デフォルトコンテナ構成案:**

- MaiRust Core + API + Web UI を 1 コンテナにバンドル
- 組み込み PostgreSQL / SQLite（デフォルトは PostgreSQL を利用）
- ストレージ: ローカルFS (`/var/lib/mairust/mail`)
- 検索エンジン: 無効（or 軽量モード）  
- S3 / 外部サービスは **すべて OFF**（設定で有効化）

```text
mairust-all-in-one:latest
  - mairust-core
  - mairust-api
  - mairust-web
  - postgres (同一コンテナ or sidecar)
````

※ 本番では DB を外出しにする構成をドキュメントで推奨。

### 1.2 ストレージ切替（S3プラグイン的構造だが同梱）

**方針:**

* コアは `StorageBackend` 抽象を持つ
* 公式ドライバとして以下を **同梱**:

  * `fs`: ローカルファイルシステム
  * `s3`: S3互換オブジェクトストレージ
* 設定で切替可能だが、**コードベースとしてはプラグイン構造**を意識する

  * 将来、Marketplace / サードパーティドライバを追加可能にするため

**config例:**

```yaml
storage:
  backend: "fs"   # default: "fs"
```

S3 に切り替える場合:

```yaml
storage:
  backend: "s3"
  options:
    bucket: "mairust-mails"
    region: "ap-northeast-1"
    endpoint: "https://s3.ap-northeast-1.amazonaws.com"
    access_key_id: "env:MAIRUST_S3_ACCESS_KEY"
    secret_access_key: "env:MAIRUST_S3_SECRET_KEY"
```

**「プラグイン的」設計の狙い:**

* 外部サービス（AWS / MinIO / Wasabi など）の仕様変更があっても、

  * `s3` ドライバ層で吸収できる
  * コアロジックはほぼ影響なし
* 将来 `storage-foo` プラグインを Marketplace から配布することも可能に

---

## 2. 送信スパム対策の設計方針

### 2.1 ゴール

* 単に「受信時にスパム判定する」だけでなく、

  * **送信時にもスパムっぽい挙動をブロック**し、
  * アカウント乗っ取り等が起きても **被害と reputational risk を最小化**する。
* 一定のしきい値を超えた場合、**スパム監視サーバーに通知**

  * デフォルトは「MaiRust 提供企業のエンドポイント」
  * 設定で「自社エンドポイント」に切替可能
* スパム挙動のルールベース＋学習データを利用し、**自動で送信停止などを行う**。

---

## 3. 送信時スパム対策のアーキテクチャ

### 3.1 pre_send Hook + Outbound Policy Engine

**コア要素:**

* `pre_send` Hook で送信前に必ずチェック
* Outbound Policy Engine（送信ポリシーエンジン）を Core 内に実装:

  * レート制限
  * 行動検知（異常な送信パターン）
  * コンテンツベースの簡易スコアリング（ルール & プラグイン）
  * 過去の送信履歴に基づく reputation スコア

**処理フロー（送信時）:**

1. ユーザー or アプリから送信（SMTP Submission / API）
2. `pre_send` Hook:

   * Outbound Policy Engine にコンテキストを渡す
3. ポリシーエンジンが判定:

   * 正常 → 通常送信
   * 疑わしい → スコア上昇 / メトリクス更新 / 軽い制限
   * 明らかにスパム → 送信ブロック + 通知 + アカウントロック等

### 3.2 どんなシグナルを見るか

**行動系（Behavioral）：**

* 短時間に大量送信（例: 1時間で何百通〜何千通）
* 同一or類似コンテンツの繰り返し送信
* 異常な宛先数（To/Cc/Bcc が極端に多い）
* 通常使っていない国/地域からのアクセス（GeoIP/ASNの変化）
* 普段使っていないクライアント/UA からの送信

**コンテンツ系（Content-based）：**

* 既知スパムパターン（ルールベース）
* 危険URLドメインの出現（ブラックリスト/脅威インテリジェンスとの連携）
* 「不自然に短いメッセージ + 画像だけ」などのパターン

**履歴系（Reputation）：**

* 過去にスパム判定された件数
* 外部ブロックリスト（RBL）への登録状況（将来の連携候補）
* 管理者による manual report

---

## 4. スパム監視サーバー連携

### 4.1 デフォルト・エンドポイント + カスタムエンドポイント

**設定イメージ:**

```yaml
outbound_spam_monitor:
  enabled: true
  endpoint: "https://monitor.mairust.io/report"   # デフォルト
  api_key: "env:MAIRUST_MONITOR_API_KEY"
  mode: "default"    # "default" | "custom" | "off"
```

カスタマイズ例（導入企業の自社エンドポイント）:

```yaml
outbound_spam_monitor:
  enabled: true
  endpoint: "https://monitor.mycompany.com/mairust"
  api_key: "env:MYCOMPANY_MONITOR_KEY"
  mode: "custom"
```

**基本方針:**

* OSS としては、「デフォルトの外部監視サービスが *設定されているサンプル*」を提供しつつ、

  * 実際には **運用者が明示的に有効化する**形が安全。
* Enterprise版や商用展開の場合は、
  「提供企業の監視サービス」＋「カスタムエンドポイント」の両対応を前提とする。

### 4.2 通知内容（例）

**プライバシーの観点から、ボディ全文は送らない**設計を推奨。

送信される情報候補:

* 送信元アカウントID（内部ID）
* 送信ドメイン
* 送信件数・宛先数・期間
* スパムスコア・ルールID一覧
* 実際のメッセージID（MaiRust内のID）
  → 必要に応じて後から API 経由で詳細を取得できるようにする

---

## 5. ルールベース学習と「送信停止」の仕組み

### 5.1 ルールベース＋統計学習

**初期フェーズ:**

* シンプルなルールエンジン＋統計的なしきい値

例：

* 「通常時の1時間あたり送信平均 + 3σ を超えたらアラート」
* 「過去24時間でスパム判定された送信が一定数を超えたら強制停止」
* 「ドメイン別/ユーザー別にしきい値を持ち、管理者が調整可能」

**将来的拡張:**

* ローカルに蓄積した統計から異常検知モデルを構築（シンプルな機械学習 or 外部AIサービス）
* 「組み込みルールセット」のアップデートをリリースごとに行う

### 5.2 フェイルセーフとしての「送信停止」

**送信停止のレベル案:**

1. ソフトリミット

   * 新規送信を遅延（キューに溜めてレートを絞る）
   * 管理者へ通知
2. ハードリミット（アカウント単位）

   * 当該ユーザーの送信を完全にブロック
   * ただし受信は許可
   * ユーザーには「送信一時停止中」の明示的なエラーメール/メッセージ
3. ドメイン/テナント単位のリミット（最悪ケース）

   * ひどいスパム挙動がテナント全体で発生した場合に備えた強制ブレーキ

**どのイベントでどのレベルに移行するか**は設定可能:

```yaml
outbound_policies:
  soft_limit_threshold: "200 msgs/hour"
  hard_limit_threshold: "500 msgs/hour"
  spam_score_threshold: 0.9
  auto_suspend: true
```

---

## 6. 送信スパム対策と Hook/Plugin の関係

### 6.1 pre_send Hook と連携するプラグイン

* 送信直前に AI プラグインを呼び出して、

  * スパムスコア / リスクスコア を算出
* 結果を Outbound Policy Engine が受け取り、

  * スコアしきい値に応じて送信許可/拒否/レート制限などを決定

### 6.2 企業ごとのカスタムルール

* 導入企業が独自の `pre_send` Hook プラグインを追加可能:

  * 業界固有のNGワード
  * 社内ポリシー（機密情報や個人情報の扱い等）
* Marketplace で「送信DLPプラグイン」なども配布可能

---

## 7. まとめ

* コンテナ配布:

  * **オールインワンのデフォルト構成（外部依存なし）**を提供し、
  * 本番では DB / S3 / 検索エンジンを外部化するベストプラクティスを提示する。
* S3:

  * **ストレージドライバ（プラグイン的実装）として同梱**し、
  * 将来の外部サービス変更に備えて Core と疎結合にする。
* 送信スパム対策:

  * `pre_send` Hook + Outbound Policy Engine で、

    * 行動／コンテンツ／履歴に基づきスコアリング
    * 一定しきい値超過で通知 & 送信停止
  * スパム監視サーバーへの通知は、

    * デフォルト提供エンドポイント + カスタムエンドポイントで柔軟に
* 全体として、

  * 「乗っ取られても被害を最小に抑えられるメール基盤」
  * 「外部サービス変更に強く、プラグインで進化し続けられる設計」
    を目指す。
