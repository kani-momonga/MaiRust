{% extends "base" %}

{% block content %}
<div x-data="inbox()" x-init="loadMessages()">
    <div class="flex gap-4">
        <!-- Sidebar -->
        <aside class="w-64 bg-white rounded-lg shadow p-4">
            <h2 class="font-semibold text-lg mb-4">Folders</h2>
            <ul class="space-y-2">
                <li>
                    <a href="#" @click.prevent="selectFolder('inbox')"
                       :class="{'bg-blue-100': currentFolder === 'inbox'}"
                       class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸ“¥</span> Inbox
                        <span x-show="unreadCount > 0" class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full ml-2" x-text="unreadCount"></span>
                    </a>
                </li>
                <li>
                    <a href="#" @click.prevent="selectFolder('sent')"
                       :class="{'bg-blue-100': currentFolder === 'sent'}"
                       class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸ“¤</span> Sent
                    </a>
                </li>
                <li>
                    <a href="#" @click.prevent="selectFolder('drafts')"
                       :class="{'bg-blue-100': currentFolder === 'drafts'}"
                       class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸ“</span> Drafts
                    </a>
                </li>
                <li>
                    <a href="#" @click.prevent="selectFolder('trash')"
                       :class="{'bg-blue-100': currentFolder === 'trash'}"
                       class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸ—‘ï¸</span> Trash
                    </a>
                </li>
            </ul>

            <h2 class="font-semibold text-lg mt-6 mb-4">Categories</h2>
            <ul class="space-y-2">
                <li>
                    <a href="#" @click.prevent="selectCategory('primary')" class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸ”µ</span> Primary
                    </a>
                </li>
                <li>
                    <a href="#" @click.prevent="selectCategory('social')" class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸŸ¢</span> Social
                    </a>
                </li>
                <li>
                    <a href="#" @click.prevent="selectCategory('promotions')" class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸŸ¡</span> Promotions
                    </a>
                </li>
                <li>
                    <a href="#" @click.prevent="selectCategory('updates')" class="block px-3 py-2 rounded hover:bg-gray-100">
                        <span class="mr-2">ğŸ”´</span> Updates
                    </a>
                </li>
            </ul>

            <h2 class="font-semibold text-lg mt-6 mb-4">Tags</h2>
            <ul class="space-y-1">
                <template x-for="tag in tags" :key="tag.id">
                    <li>
                        <a href="#" @click.prevent="filterByTag(tag.id)"
                           class="block px-3 py-1 rounded hover:bg-gray-100 text-sm">
                            <span class="inline-block w-3 h-3 rounded-full mr-2" :style="`background-color: ${tag.color || '#888'}`"></span>
                            <span x-text="tag.name"></span>
                        </a>
                    </li>
                </template>
            </ul>
        </aside>

        <!-- Message List -->
        <div class="flex-1">
            <!-- Toolbar -->
            <div class="bg-white rounded-lg shadow p-4 mb-4 flex items-center gap-4">
                <input type="checkbox" @change="selectAll($event)" class="w-4 h-4">
                <button @click="refreshMessages()" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">
                    ğŸ”„ Refresh
                </button>
                <button @click="deleteSelected()" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" x-show="selectedMessages.length > 0">
                    ğŸ—‘ï¸ Delete
                </button>
                <button @click="markAsRead()" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" x-show="selectedMessages.length > 0">
                    âœ“ Mark as Read
                </button>
                <div class="flex-1"></div>
                <input type="search" placeholder="Search messages..."
                       @input.debounce.300ms="search($event.target.value)"
                       class="px-3 py-1 border rounded w-64">
            </div>

            <!-- Messages -->
            <div class="bg-white rounded-lg shadow divide-y">
                <template x-if="loading">
                    <div class="p-8 text-center text-gray-500">
                        Loading messages...
                    </div>
                </template>
                <template x-if="!loading && messages.length === 0">
                    <div class="p-8 text-center text-gray-500">
                        No messages found
                    </div>
                </template>
                <template x-for="message in messages" :key="message.id">
                    <div class="p-4 hover:bg-gray-50 cursor-pointer flex items-center gap-4"
                         :class="{'font-semibold bg-blue-50': !message.seen}"
                         @click="openMessage(message.id)">
                        <input type="checkbox" :checked="selectedMessages.includes(message.id)"
                               @click.stop="toggleSelect(message.id)" class="w-4 h-4">
                        <button @click.stop="toggleStar(message.id)"
                                :class="message.flagged ? 'text-yellow-500' : 'text-gray-300'">
                            â­
                        </button>
                        <div class="w-48 truncate" x-text="message.from_address || 'Unknown'"></div>
                        <div class="flex-1 truncate">
                            <span x-text="message.subject || '(no subject)'"></span>
                            <span class="text-gray-500 font-normal" x-text="' - ' + (message.body_preview || '').substring(0, 50)"></span>
                        </div>
                        <div class="flex gap-1">
                            <template x-for="tag in message.tags" :key="tag">
                                <span class="text-xs px-2 py-1 rounded bg-gray-200" x-text="tag"></span>
                            </template>
                        </div>
                        <div class="text-sm text-gray-500 w-24 text-right" x-text="formatDate(message.received_at)"></div>
                    </div>
                </template>
            </div>

            <!-- Pagination -->
            <div class="mt-4 flex justify-center gap-2" x-show="totalPages > 1">
                <button @click="prevPage()" :disabled="currentPage === 1"
                        class="px-3 py-1 bg-white rounded shadow disabled:opacity-50">
                    â† Previous
                </button>
                <span class="px-3 py-1">Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></span>
                <button @click="nextPage()" :disabled="currentPage === totalPages"
                        class="px-3 py-1 bg-white rounded shadow disabled:opacity-50">
                    Next â†’
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function inbox() {
    return {
        messages: [],
        tags: [],
        loading: true,
        currentFolder: 'inbox',
        currentCategory: null,
        selectedMessages: [],
        unreadCount: 0,
        currentPage: 1,
        totalPages: 1,
        perPage: 50,

        async loadMessages() {
            this.loading = true;
            try {
                // TODO: Replace with actual API call
                // const response = await fetch(`${window.API_URL}/messages?folder=${this.currentFolder}&page=${this.currentPage}`);
                // this.messages = await response.json();

                // Demo data
                this.messages = [
                    {
                        id: '1',
                        from_address: 'sender@example.com',
                        subject: 'Welcome to MaiRust!',
                        body_preview: 'Thank you for trying MaiRust mail server...',
                        received_at: new Date().toISOString(),
                        seen: false,
                        flagged: false,
                        tags: ['important']
                    },
                    {
                        id: '2',
                        from_address: 'noreply@social.com',
                        subject: 'New connection request',
                        body_preview: 'Someone wants to connect with you...',
                        received_at: new Date(Date.now() - 3600000).toISOString(),
                        seen: true,
                        flagged: true,
                        tags: ['social']
                    }
                ];
                this.unreadCount = this.messages.filter(m => !m.seen).length;
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
            this.loading = false;
        },

        async loadTags() {
            // TODO: Load tags from API
            this.tags = [
                { id: '1', name: 'Important', color: '#EF4444' },
                { id: '2', name: 'Work', color: '#3B82F6' },
                { id: '3', name: 'Personal', color: '#10B981' }
            ];
        },

        selectFolder(folder) {
            this.currentFolder = folder;
            this.currentCategory = null;
            this.currentPage = 1;
            this.loadMessages();
        },

        selectCategory(category) {
            this.currentCategory = category;
            this.currentPage = 1;
            this.loadMessages();
        },

        filterByTag(tagId) {
            this.currentPage = 1;
            // TODO: Filter by tag
            this.loadMessages();
        },

        openMessage(id) {
            window.location.href = `/message/${id}`;
        },

        toggleSelect(id) {
            const idx = this.selectedMessages.indexOf(id);
            if (idx === -1) {
                this.selectedMessages.push(id);
            } else {
                this.selectedMessages.splice(idx, 1);
            }
        },

        selectAll(event) {
            if (event.target.checked) {
                this.selectedMessages = this.messages.map(m => m.id);
            } else {
                this.selectedMessages = [];
            }
        },

        async toggleStar(id) {
            const message = this.messages.find(m => m.id === id);
            if (message) {
                message.flagged = !message.flagged;
                // TODO: API call to update flag
            }
        },

        async deleteSelected() {
            // TODO: API call to delete messages
            this.messages = this.messages.filter(m => !this.selectedMessages.includes(m.id));
            this.selectedMessages = [];
        },

        async markAsRead() {
            // TODO: API call to mark as read
            this.messages.forEach(m => {
                if (this.selectedMessages.includes(m.id)) {
                    m.seen = true;
                }
            });
            this.selectedMessages = [];
            this.unreadCount = this.messages.filter(m => !m.seen).length;
        },

        refreshMessages() {
            this.loadMessages();
        },

        search(query) {
            // TODO: API search
            console.log('Searching:', query);
        },

        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadMessages();
            }
        },

        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadMessages();
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 86400000 && date.getDate() === now.getDate()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 86400000 * 7) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        },

        init() {
            this.loadMessages();
            this.loadTags();
        }
    };
}
</script>
{% endblock %}
